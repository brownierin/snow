rules:
- id: go.lang.security.audit.net.dynamic-httptrace-clienttrace.dynamic-httptrace-clienttrace
  message: |
    Detected a potentially dynamic ClientTrace. This occurred because semgrep detected use of
    ClientTrace without a static definition for '$TRACE'. Dynamic ClientTraces are dangerous because
    they deserialize function code to run when certain request events occur.  The function
    WithClientTrace in net/http/httptrace eventually creates arbitrary functions via reflect's MakeFunc
    This means a dynamic trace could define arbitrary functions and then call them.
  metadata:
    cwe: 'CWE-913: Improper Control of Dynamically-Managed Code Resources'
    owasp: 'A8: Insecure Deserialization'
    references:
    - https://github.com/returntocorp/semgrep-rules/issues/518
  # Detects when a static ClientTrace is not defined in the same file as
  # WithClientTrace. Not a perfect detection, but sufficiently works in a
  # scan of ~1k repos: https://dev.massive.ret2.co/triager/filter/1007
  patterns:
  - pattern-not-inside: |
      ...
      &httptrace.ClientTrace { ... }
      ...
  - pattern: httptrace.WithClientTrace($ANY, $TRACE)

  severity: WARNING
  languages:
  - go
